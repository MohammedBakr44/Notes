
We need to understand `Windows Internals` before we conduct analysis.

Windows operates in two main modes:

- `User Mode`: This is the default mode where most applications and users processes operate. In this mode, application have limited access to system resources and must interact through an API. These processes are isolated and can't directly access hardware and critical system functions. However, malware can still manipulate files, registry settings, network connections; it may attempt to escalate privileges.

- `Kernel Mode`: Kernel model is a highly privileged mode, the Kernel has unrestricted access to system resources, hardware, and critical functions. *If malware operates in kernel mode, it gains elevated control and can manipulate system behavior, conceal its presence, intercept system calls, and tamper with security mechanisms.*

## Windows Architecture At A High Level

![](https://i.imgur.com/bstMm0u.png)

### User-mode Components

Those are parts of the operating system that don't have direct access to hardware or kernel data; they interact with system resources through APIs and system calls.

- `System Support Processes`: These are components that provide crucial functionalities e.g: `winlogon.exe`, `smss.exe` Session Manager, and Service Control Manager `services.exe`.

- `Service Proccesses`: Host Windows services like the `Windows Update Service`, `Task Scheduler`, and `Print Spooler` services. They usually run in the background.

- `User Applications`. Processes create by user programs. They interact with system through Windows `APIs`. These API calls get redirected to `NTDLL.dll`; **which triggers a transition from user mode to kernel mode**, where the `system call` gets executed.

- `Environment Subsystems`: Responsible for providing execution environments for specific types of applications or process. They include the `Win32 Subsystem`, `POSIX`, `OS/2`.

- `Subsystem DLLs`: Translate documented functions into appropriate system calls: `NTDLL.dll`, `kernelbasse.dll`, `user32.dll`, `wininet.dll`, and `advapi32.dll`.

### Kernel-mode Components

Parts that have direct access to hardware and kernel data structures.

- `Executive`: This upper layer in kernel mode gets accessed through functions from `NTDLL.dll`. It consists of components like the `I/O Manager`, `Object Manager`, `Security Reference Minitor`, `Process Manager`. It runs some checks first, and then process the call to kernel.

- `Kernel`: Manages system resources, provide low-level services like `thread scheduling`, `interrupt and execution dispatching`, and `multiprocessor sync`.

- `Device Drivers`: enable the OS to interact with hardware devices. They serve as intermediaries, allowing the system to manage and control resources.

- `Hardware Abstraction Layer(HAL)`: Provides abstraction layer between the hardware devices and OS.

- `Windowing and Graphics System (win32k.sys)`: This subsystem is responsible for managing the GUI and rendering visual elements on the screen.


### Windows API Call Flow

>Let's consider an example of a Windows API call flow, where a user-mode application tries to access privileged operations and system resources using the [ReadProcessMemory function](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory). This function allows a process to read the memory of a different process.

![](https://i.imgur.com/Iu26sAJ.png)


